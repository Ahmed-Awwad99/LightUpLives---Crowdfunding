{% extends "base.html" %}
{% load static %}
{% block title %}
{{ project.title }}
{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">

<div class="container mt-5">
  <div class="row align-items-center">
    <!-- Left Section: Text Content -->
    <div class="col-md-6">
      <h1 class="fw-bold text-primary">{{ project.title }}</h1>
      <h5 class="text-muted">Image description and details</h5>

      <p class="text-dark">{{ project.description }}</p>
      <p><strong>Category:</strong> 
        <a href="{% url 'projects_by_category' project.category.name %}" class="badge bg-success">{{ project.category.name }}</a>
      </p>
      <p><strong>Target:</strong> <span class="text-primary">{{ project.target }} EGP</span></p>
      <p><strong>Total Donated:</strong> <span class="text-success">{{ total_donated }} EGP</span></p>
      <p><strong>Remaining:</strong> <span class="text-danger">{{ remaining }} EGP</span></p>
      <p><strong>Tags:</strong>
        {% for tag in project.tags.all %}
            <a href="{% url 'projects_by_tag' tag.name %}" class="badge bg-primary text-white">{{ tag.name }}</a>
        {% endfor %}
      </p>

    </div>

    <!-- Right Section: Image -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div id="project-slider" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner">
            {% for image in project.images.all %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <img
                src="{{ image.image.url }}"
                class="d-block w-100 rounded"
                alt="Project Image"
                style="object-fit: cover; height: 300px;"
              />
            </div>
            {% endfor %}
          </div>
          <button
            class="carousel-control-prev"
            type="button"
            data-bs-target="#project-slider"
            data-bs-slide="prev"
          >
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button
            class="carousel-control-next"
            type="button"
            data-bs-target="#project-slider"
            data-bs-slide="next"
          >
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% if messages %}
<div class="alert alert-info mt-3">
  {% for message in messages %}
  <p>{{ message }}</p>
  {% endfor %}
</div>
{% endif %}

{% if project.cancelled %}
<p class="text-danger mt-4">
  This project has been canceled and is no longer accepting donations.
</p>
{% elif donation_closed %}
<p class="text-success mt-4">
  Thank you, Donation for this project has been completed.
</p>
{% else %}
{% if user.is_authenticated %}
<a href="{% url 'report_project' project.id %}" class="btn btn-danger mt-3">Report Project</a>
{% endif %}
<div class="container mt-5">
  <h2 class="text-primary">Donate to this project</h2>
  <form method="POST" class="mt-3">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" name="donate" class="btn btn-success">Donate</button>
  </form>
</div>
{% endif %}

<h2 class="mt-5 text-primary">Donations</h2>
<ul class="list-group mt-3">
  {% for donation in donations %}
  <li class="list-group-item">
    <strong>{{ donation.donor.email }}</strong> donated <span class="text-success">{{ donation.amount }} EGP</span> on {{ donation.donated_at|date:"d M Y H:i" }}
  </li>
  {% endfor %}
</ul>

<h2 class="mt-5 text-primary">Comments</h2>
<ul class="list-group mt-3">
  {% for comment in comments %}
  <li class="list-group-item">
    <strong>{{ comment.user.email }}</strong> ({{ comment.created_at|date:"d M Y H:i" }}): {{ comment.content }}
  </li>
  {% endfor %}
</ul>

<h2 class="mt-5 text-success">Average Rating: <span>{{ average_rating|floatformat:1 }}</span></h2>

{% if user.is_authenticated %}
<div class="rate-project">
  <h3 class="text-success">Rate this Project</h3>
  <form method="POST" class="mt-3">
    {% csrf_token %}
    <div class="star-rating">
      <input type="radio" id="star5" name="value" value="5">
      <label for="star5" title="5 stars">&#9733;</label>
      <input type="radio" id="star4" name="value" value="4">
      <label for="star4" title="4 stars">&#9733;</label>
      <input type="radio" id="star3" name="value" value="3">
      <label for="star3" title="3 stars">&#9733;</label>
      <input type="radio" id="star2" name="value" value="2">
      <label for="star2" title="2 stars">&#9733;</label>
      <input type="radio" id="star1" name="value" value="1">
      <label for="star1" title="1 star">&#9733;</label>
    </div>
    <button type="submit" name="rate" class="btn btn-success mt-3">Submit Rating</button>
  </form>
</div>
{% else %}
<p class="mt-3"><a href="{% url 'sign_in' %}" class="text-success">Sign in</a> to rate this project.</p>
{% endif %}

<div class="add-comment">
  <h3 class="text-success">Add a Comment</h3>
  <form method="POST" class="mt-3">
    {% csrf_token %}
    {{ comment_form.as_p }}
    <button type="submit" name="comment" class="btn">Post Comment</button>
  </form>
</div>

<h2 class="mt-5 text-primary">Similar Projects</h2>
<div class="similar-projects">
  {% for similar_project in similar_projects %}
  <div class="card">
    <img
      src="{{ similar_project.images.first.image.url }}"
      class="card-img-top"
      alt="{{ similar_project.title }}"
      style="object-fit: cover; height: 200px;"
    />
    <div class="card-body">
      <h5 class="card-title text-primary">{{ similar_project.title }}</h5>
      <p class="card-text text-muted">{{ similar_project.description|truncatechars:100 }}</p>
      <a href="{% url 'project_detail' similar_project.id %}" class="btn btn-primary">View Project</a>
    </div>
  </div>
  {% empty %}
  <p>No similar projects found.</p>
  {% endfor %}
</div>
{% endblock %}
